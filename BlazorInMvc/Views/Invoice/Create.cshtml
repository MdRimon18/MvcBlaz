@model Domain.ViewModel.InvoiceViewModel
<style>
    .hidden {
        display: none;
    }

    .form-rounded {
        border-radius: 5px; /* Adjust as desired */
    }
</style>

<div class="offcanvas offcanvas-end" id="offcanvasRight" tabindex="-1" aria-labelledby="offcanvasRightLabel" style="width: 55%;">
    <div class="offcanvas-header">
        @*  <div class="card-header">
        <h5 class="mb-0" data-anchor="data-anchor">
        <i class="fas fa-arrow-left"></i>
        Customer/Buyer Profile
        </h5>
        </div> *@
        <button class="btn-close text-reset" type="button" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body bg-body-tertiary">
     @*    @await Html.PartialAsync("/Views/Patient/CreateProfile.cshtml",Model.Suppliers) *@

    </div>
</div>

<div class="offcanvas offcanvas-end" id="offcanvasRight-1" tabindex="-1" aria-labelledby="offcanvasRightLabel" style="width: 50%;">
    <div class="offcanvas-header">
        <div class="card-header">
            <h5 class="mb-0">
                @*  <i class="fas fa-arrow-left"></i> *@
                Choose Product
            </h5>
        </div>
        <button class="btn-close text-reset" type="button" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content border-0">
                <div class="modal-body p-0">
                    <div class="d-lg-flex justify-content-between">
                        <div class="row flex-between-center gy-2 px-1 mb-2">
                            <div class="col-auto pe-0">
                                <div class="input-group" style="max-width: 350px; width: 100%;">
                                    <input class="form-control form-control-sm shadow-none"
                                           type="search"
                                           placeholder="Search by Name/SKU/Code"
                                           aria-label="search"
                                           asp-for="SrchQuery"
                                    oninput="OnProductSearchInOffCanva" />

                                    <button type="button" class="btn btn-sm btn-outline-secondary border-300 hover-border-secondary">
                                        <span class="fa fa-search fs-10"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-0">


                        @foreach (var item in  Model.FilteredItemsOffCanva)
                        {
                            <div class="col-md-4 ps-md-2">
                                <div class="card mb-3 zoom-card">
                                    @* <div class="card-header">
                                <h5 class="mb-0">Laptop</h5>
                                </div> *@
                                    <div class="card-body bg-body-tertiary">
                                        <div class="tab-content">
                                            <div class="tab-pane preview-tab-pane active" role="tabpanel">
                                                <div class="avatar avatar-4xl mb-3">
                                                    <img class="rounded-soft" src="~/assets/img/products/1.jpg" alt="Product Image" />
                                                </div>
                                                <!-- Additional Product Information -->
                                                <div class="product-info">
                                                    <p class="mb-1"><strong>Category:</strong> @item.ProdCtgName</p>
                                                    <p class="mb-1"><strong>Brand:</strong> BrandName</p>
                                                    <p class="mb-1"><strong>Name:</strong> @item.ProdName</p>
                                                    <p class="mb-1"><strong>Price:</strong> @item.SellingPrice</p>
                                                    <p class="mb-1"><strong>SKU:</strong> @item.Sku</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-end mt-3">
                                            <button class="btn btn-sm btn-falcon-primary" type="button" onclick="() => OnSelectProduct(item)">
                                                Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>



                        }



                    </div>
                </div>
            </div>
        </div>
    </div>
    @* <div class="card-footer">
    <div class="row">
    <div class="pagination d-none"></div>
    <div class="col-md-8">
    <div class="row">
    <div class="col-md-6">
    <span class="d-none d-sm-inline-block me-2 fs-10">page 1 of 1, Total Record 9 </span>

    </div>
    <div class="col-md-2">

    <PageSizeSelection SelectedPageSize="1" SelectedPageSizeChanged="HandlePageSizeChanged" />
    </div>
    </div>
    </div>
    <div class="col-md-4">
    <div class="col-auto d-flex justify-content-end">

    <PaginationV2 TotalPages="1" CurrentPage="5" OnPageChange="ChangePage" />

    </div>
    </div>

    </div>

    </div> *@
</div>

<div class="offcanvas offcanvas-end" id="offcanvasRight-2" tabindex="-1" aria-labelledby="offcanvasRightLabel" style="width: 50%;">
    <div class="offcanvas-header">
        <div class="card-header">
            <h5 class="mb-0">
                @*  <i class="fas fa-arrow-left"></i> *@
                Choose Product
            </h5>
        </div>
        <button class="btn-close text-reset" type="button" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">

       <p>Set Page Serial</p>
    </div>
    @* <div class="card-footer">
    <div class="row">
    <div class="pagination d-none"></div>
    <div class="col-md-8">
    <div class="row">
    <div class="col-md-6">
    <span class="d-none d-sm-inline-block me-2 fs-10">page 1 of 1, Total Record 9 </span>

    </div>
    <div class="col-md-2">

    <PageSizeSelection SelectedPageSize="1" SelectedPageSizeChanged="HandlePageSizeChanged" />
    </div>
    </div>
    </div>
    <div class="col-md-4">
    <div class="col-auto d-flex justify-content-end">

    <PaginationV2 TotalPages="1" CurrentPage="5" OnPageChange="ChangePage" />

    </div>
    </div>

    </div>

    </div> *@
</div>

@foreach (var tp in Model.InvoiceTypeList.OrderBy(o=>o.InvoiceTypeId))
{
    <button class="btn btn-falcon-default btn-sm ms-2 toggle-button" type="button" onclick="">@tp.InvoiceTypeName</button>

}

<div class="card mt-2">

    <div class="card-header bg-body-tertiary">
        <h5 class="mb-0"><i class="fas fa-arrow-left"></i>Create Invoice</h5>
    </div>
    <div class="card-body">
       
       
            <div class="tab-content">
                <div class="row g-3">
                    <div class="col-lg-10 col-md-10 col-sm-10 col-10">
                        <form>


                            <div class="row g-3">
                               @*  <div class="col-lg-3 col-md-3 col-sm-9 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="InvoiceType" class="form-label fw-semi-bold">Invoice Type</label><span class="error-star">*</span>
                                        <select asp-for="Invoice.InvoiceTypeId" id="InvoiceType" class="form-select form-rounded form-select-sm">
                                            <option value="">Select Invoice Type</option>
                                            @foreach (var item in Model.InvoiceTypeList)
                                            {
                                                <option value="@item.InvoiceTypeId">@item.InvoiceTypeName</option>
                                            }
                                        </select>
                                        <span asp-validation-for="Invoice.InvoiceTypeId" class="text-danger"></span>
                                    </div>
                                </div> *@

                           
                            <div class="col-lg-3 col-md-3 col-sm-9 col-9 animated-div">
                                <div class="form-group">
                                    <label for="CustomerEmail" class="form-label fw-semi-bold">Customer Name<span class="error-star">*</span></label>
                                    <input type="text" style="border-radius: 5px;" asp-for="CustomerEmail" id="CustomerEmail" class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="Customer Name" />
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-3 col-sm-6 col-9 animated-div">
                                <div class="form-group">
                                    <label for="chooseMobile" class="form-label fw-semi-bold">Mobile</label><span class="error-star">*</span>
                                    <div class="position-relative input-group">
                                        <input type="text" class="form-control form-control-sm form-rounded" placeholder="Search..." id="chooseMobile" />
                                        <button class="btn btn-sm btn-light" type="button" id="plusButton" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">+</button>
                                    </div>
                                </div>
                            </div>
                                <div class="col-lg-3 col-md-3 col-sm-9 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="CustomerEmail" class="form-label fw-semi-bold">Customer Email</label>
                                        <input type="text" style="border-radius: 5px;" asp-for="CustomerEmail" id="CustomerEmail" class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="Customer Email" />
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-3 col-sm-9 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="NotificationById" class="form-label fw-semi-bold">Notification Send By</label><span class="error-star">*</span>
                                        <select asp-for="Invoice.NotificationById" id="NotificationById" class="form-select form-rounded form-select-sm">
                                            <option value="">Select Notification</option>
                                            @foreach (var item in Model.NotificationByList)
                                            {
                                                <option value="@item.NotificationById">@item.NotificationByName</option>
                                            }
                                        </select>
                                        <span asp-validation-for="Invoice.NotificationById" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-3 col-sm-9 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="InvoiceDateTime" class="form-label fw-semi-bold">Date</label>
                                        <input type="date" asp-for="Invoice.InvoiceDateTime" id="InvoiceDateTime" class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="Date" />
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-3 col-sm-6 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="SalesByName" class="form-label fw-semi-bold">Seller</label>
                                        <input asp-for="Invoice.SalesByName" id="SalesByName" readonly name="salesBy" type="text" class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="seller" required />
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-3 col-sm-9 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="PaymentTypeId" class="form-label fw-semi-bold">Payment Type</label><span class="error-star">*</span>
                                        <select asp-for="Invoice.PaymentTypeId" id="PaymentTypeId" class="form-select form-rounded form-select-sm">
                                            <option value="">Select Payment Type</option>
                                            @foreach (var item in Model.PaymentTypesList)
                                            {
                                                <option value="@item.PaymentTypeId">@item.PaymentTypesName</option>
                                            }
                                        </select>
                                        <span asp-validation-for="Invoice.PaymentTypeId" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-3 col-sm-9 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="categorySelect" class="form-label fw-semi-bold">Category</label>
                                        <select id="categorySelect" class="form-select form-rounded form-select-sm">
                                            <option value="">Select Category</option>
                                            @foreach (var item in Model.ProductCategoryList)
                                            {
                                                <option value="@item.ProdCtgId">@item.ProdCtgName</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-3 col-sm-6 col-12 animated-div">
                                    <div class="form-group">
                                        <label for="subCategorySelect" class="form-label fw-semi-bold">Sub Category</label>
                                        <select id="subCategorySelect" class="form-select form-rounded form-select-sm">
                                            <option value="">Select Sub Category</option>
                                            @foreach (var item in Model.ProductSubCategoryList)
                                            {
                                                <option value="@item.ProdSubCtgId">@item.ProdSubCtgName</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                            
                                @* <div class="col-lg-4 col-md-4 col-sm-6 col-9 animated-div">
                                    <div class="form-group">
                                        <label for="chooseProduct" class="form-label fw-semi-bold">Search by Product Name/Sku/Code</label><span class="error-star">*</span>
                                        <div class="position-relative input-group">
                                            <input type="text" class="form-control form-control-sm form-rounded" placeholder="Search..." id="chooseProduct" />
                                            <button class="btn btn-sm btn-light" type="button" id="plusButton" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight-1" aria-controls="offcanvasRight-1">+</button>
                                        </div>
                                    </div>
                                </div> *@
                            <div class="col-lg-6 col-md-6 col-sm-6 col-12 animated-div">
                                <div class="form-group position-relative">
                                    <label for="chooseProduct" class="form-label fw-semi-bold">Search by Product Name/Sku/Code</label><span class="error-star text-danger">*</span>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control form-control-sm form-rounded border-start-0" placeholder="Search..." id="chooseProduct" aria-label="Search" oninput="handleSearch(this.value)" />
                                        <!-- Clear (X) button -->
                                        <button type="button" class="btn btn-sm  position-absolute top-0 end-0 me-5 d-none" id="clearBtn">×</button>

                                        <button class="btn btn-sm btn-light" type="button" id="plusButton" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight-1" aria-controls="offcanvasRight-1">+</button>
                                    </div>
                                    <div class="dropdown-menu border font-base mt-1 w-100 spa-link" id="searchDropdown" style="display: none;">
                                        <div class="list py-2" style="max-height: 15rem; overflow-y: auto;"></div>
                                        <div class="text-center">
                                            <p class="fw-bold fs-8 d-none">No Results Found.</p>
                                        </div>
                                    </div>
                                </div>
                              @*   <div class="form-group position-relative">
                                    <label for="chooseProduct" class="form-label fw-semi-bold">Search by Product Name/Sku/Code</label><span class="error-star text-danger">*</span>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control form-control-sm form-rounded border-start-0" placeholder="Search..." id="chooseProduct" aria-label="Search" />
                                        <button class="btn btn-sm btn-light" type="button" id="plusButton" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight-1" aria-controls="offcanvasRight-1">+</button>
                                    </div>
                                    <!-- Optional Dropdown (if you want to add search suggestions like the first snippet) -->
                                    <div class="dropdown-menu border font-base mt-1 w-100" id="searchDropdown" style="display: none;">
                                        <div class="list py-2" style="max-height: 15rem; overflow-y: auto;">
                                            <!-- Dynamic content can be added here via JavaScript -->

                                            <h6 class="dropdown-header fw-medium text-uppercase px-x1 fs-11 pt-0 pb-2">Members</h6><a class="dropdown-item px-x1 py-2" href="../../pages/user/profile.html">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar avatar-l status-online me-2">
                                                        <img class="rounded-circle" src="../../assets/img/team/1.jpg" alt="" />
                                                    </div>
                                                    <div class="flex-1">
                                                        <h6 class="mb-0 title">Anna Karinina</h6>
                                                        <p class="fs-11 mb-0 d-flex">Technext Limited</p>
                                                    </div>
                                                </div>
                                            </a>
                                            <a class="dropdown-item px-x1 py-2" href="../../pages/user/profile.html">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar avatar-l me-2">
                                                        <img class="rounded-circle" src="../../assets/img/team/2.jpg" alt="" />
                                                    </div>
                                                    <div class="flex-1">
                                                        <h6 class="mb-0 title">Antony Hopkins</h6>
                                                        <p class="fs-11 mb-0 d-flex">Brain Trust</p>
                                                    </div>
                                                </div>
                                            </a>


                                        </div>
                                        <div class="text-center">
                                            <p class="fw-bold fs-8 d-none">No Results Found.</p>
                                        </div>
                                    </div>
                                </div> *@
                            </div>

                            <div class="col-sm-3 col-md-3 col-lg-3 col-12">
                                    <div class="form-group">
                                        <label for="remarks" class="form-label fw-semi-bold">Notes</label>
                                        <textarea asp-for="Invoice.Notes" id="remarks" class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="Notes" cols="60" rows="1"></textarea>
                                    </div>
                                </div>
                            </div>


                            @* Item List Array *@
                            <div class="row">
                                <div class="table-responsive scrollbar mt-4">
                                    <table class="table table-sm mb-0 fs-10 table-view-tickets">
                                        <thead class="thdchild">
                                            <tr>
                                                <th class="form-label fw-bold">Image</th>
                                                <th scope="col" class="form-label fw-bold">Category</th>
                                               <th scope="col" class="form-label fw-bold">Sub Ctg.</th>
                                                <th scope="col" class="form-label fw-bold">Name</th>
                                                <th scope="col" class="form-label fw-bold">Quantity <span class="error-star"><strong class="bigger-asterisk">*</strong></span></th>
                                                <th scope="col" class="form-label fw-bold">Unit</th>
                                                <th scope="col" class="form-label fw-bold">Rate</th>
                                                <th scope="col" class="form-label fw-bold">VAT(%)</th>
                                                <th scope="col" class="form-label fw-bold">Discount(%)</th>
                                                <th scope="col" class="form-label fw-bold">Amount</th>
                                                <th scope="col" class="form-label fw-bold">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                int indexx = 0;
                                            }
                                            @foreach (var itm in Model.ItemsList)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="col-auto">
                                                            <div class="avatar avatar-2xl">
                                                                <img class="rounded-circle" src="~/assets/img/products/1.jpg" alt="@itm.ProductName" />
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" placeholder="Category" readonly value="@itm.CategoryName">
                                                    </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" placeholder="Sub Ctg." readonly value="@itm.SubCtgName">
                                                </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" placeholder="Name" readonly value="@itm.ProductName">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" placeholder="Quantity" name="ItemsList[@indexx].Quantity" value="@itm.Quantity" />
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm form-rounded fw-semi-bold" readonly placeholder="Unit" value="@itm.Unit">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="Rate" name="ItemsList[@indexx].SellingPrice" value="@itm.SellingPrice">
                                                    </td>
                                                    <td>
                                                        <input type="number" readonly class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="V(%)" value="@itm.VatPercentg">
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control form-control-sm form-rounded fw-semi-bold" placeholder="D(%)" name="ItemsList[@indexx].DiscountPercentg" value="@itm.DiscountPercentg">
                                                    </td>
                                                    <td>
                                                        <input readonly type="number" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" placeholder="Amount" value="@itm.TotalPrice">
                                                    </td>
                                                    <td class="treeview">
                                                        <div class="treeview-list-item">
                                                            <a data-bs-toggle="collapse" href="#treeviewExample-1_@indexx" role="button" aria-expanded="false">
                                                                <p class="treeview-text">Serial</p>
                                                            </a>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <button type="button" title="Info" class="btn btn-sm a-light" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                                                            <i class="fa fa-info-circle" style="font-size:18px"></i>
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <button title="Delete" class="btn btn-sm btn-light" onclick="deleteItem('@itm.ProductId')">
                                                            <i class="far fa-trash-alt fa-lg text-danger"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="12">
                                                        <div class="collapse treeview-list" id="treeviewExample-1_@indexx">
                                                            <div class="table-responsive scrollbar row">
                                                                <div class="col-sm-8 col-md-8 col-lg-8 col-xl-8">
                                                                    <table class="table table-hover">
                                                                        <thead>
                                                                            <tr>
                                                                                <th class="fw-semi-bold" scope="col">Product Name</th>
                                                                                <th scope="col">Serial No</th>
                                                                                <th scope="col">Supplier Org</th>
                                                                                <th scope="col">Action</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                        @foreach (var srl in itm.SelectedSerialNumbers)
                                                                            {
                                                                                <tr class="hover-actions-trigger">
                                                                                    <td class="align-middle text-nowrap">
                                                                                        <div class="d-flex align-items-center">
                                                                                            <div class="avatar avatar-xl">
                                                                                                <img class="rounded-circle" src="../../assets/img/team/4.jpg" alt="" />
                                                                                            </div>
                                                                                            <div class="ms-2">@srl.ProductId</div>
                                                                                        </div>
                                                                                    </td>
                                                                                    <td class="align-middle">@srl.SerialNumber</td>
                                                                                    <td class="align-middle text-nowrap">@srl.SupplierOrgName</td>
                                                                                    <td>
                                                                                        <button onclick="deleteSerialNumber('@srl.SerialNumber')" class="btn btn-tertiary ps-2" title="Delete">
                                                                                            <span class="fas fa-trash-alt text-danger"></span>
                                                                                        </button>
                                                                                    </td>
                                                                                </tr>
                                                                            }
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                                <div class="col-sm-4 col-md-4 col-lg-4 col-xl-4">
                                                                    <label for="chooseSerialNumber" class="form-label fw-semi-bold">Add Serial Number</label>
                                                                    <div class="position-relative">
                                                                        <!-- Add any custom search component HTML or code here -->
                                                                        <button class="btn btn-sm btn-light position-absolute end-0 h-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight-2" aria-controls="offcanvasRight-2">
                                                                            +
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                indexx++;
                                            }
                                        </tbody>
                                    </table>
                                </div>

                            </div>

                            <div class="row align-items-center mt-2">
                                <div class="col-auto d-flex">
                                <a class="btn btn-outline-primary btn-sm me-1 mb-1 spa-link" onclick="postItemsToApi()">Create Invoice</a>

                                <a   class="btn btn-outline-primary btn-sm me-1 mb-1 spa-link"   onclick="loadPage('/Invoice/ShippingWithPayment')">Shipping</a>

                                    <button class="btn btn-outline-secondary me-1 mb-1" type="button">Refresh</button>
                                </div>
                            </div>
                        </form>
                        <div class="row mt-4">
                        </div>

                    </div>

                    <div class="col-lg-2 col-md-2 col-sm-2 col-2">
                        <div class="form-group">
                            <label class="form-label fw-bolder">Total Quantity</label>
                            <input asp-for="Invoice.TotalQnty" type="number" class="form-control form-control-sm form-rounded fw-bold" readonly placeholder="Total Quantity" />
                        </div>
                        <div class="form-group">
                            <label class="form-label fw-bolder">Total</label>
                            <input asp-for="Invoice.TotalAmount" type="number" class="form-control form-control-sm form-rounded fw-bold" readonly placeholder="Total Amount" />
                        </div>
                        <div class="form-group">
                            <label class="form-label fw-bold">Vat</label>
                            <input asp-for="Invoice.TotalVat" type="number" class="form-control form-control-sm form-rounded fw-bold" readonly placeholder="Vat(%)" />
                        </div>
                        <div class="form-group">
                            <label class="form-label fw-bold">Discount</label>
                            <input asp-for="Invoice.TotalDiscount" type="number" class="form-control form-control-sm form-rounded fw-bold" readonly placeholder="Discount(%)" />
                        </div>
                        <div class="form-group">
                            <label class="form-label fw-bold">Additional Discount</label>
                            <input asp-for="Invoice.TotalAddiDiscount" type="number"
                                   class="form-control form-control-sm form-rounded fw-bold"
                                   placeholder="Additional Discount" />
                        </div>

                        <div class="form-group">
                            <label class="form-label fw-bolder">Total Payable</label>
                            <input asp-for="Invoice.TotalPayable" type="number" class="form-control form-control-sm form-rounded fw-bold" placeholder="Total Payable" />
                        </div>
                        <div class="form-group">
                            <label class="form-label fw-bolder">Receive</label>
                            <input asp-for="Invoice.RecieveAmount" type="number" class="form-control form-control-sm form-rounded fw-bold"
                                   placeholder="Receive" oninput="OnChangeReceiveAmount" />

                        </div>
                        <div class="form-group">
                            <label class="form-label fw-bolder">Current Due</label>
                            <input asp-for="Invoice.DueAmount" type="number"
                                   class="form-control form-control-sm form-rounded fw-bold" placeholder="Current Due" />
                        </div>
                    </div>


                </div>
            </div>

            <div class="border-bottom border-dashed my-5"></div>
            <div class="row">
                <div class="col-md-7 col-xl-12 col-xxl-7 px-md-3 mb-xxl-0 position-relative">
                    <div class="d-flex">
                        <img class="me-3" src="../../assets/img/icons/shield.png" alt="" width="60" height="60" />
                        <div class="flex-1">
                            <h5 class="mb-2">Buyer/Customer Protection</h5>
                            <div class="form-check mb-0">
                                <input class="form-check-input" id="protection-option-1" type="checkbox" checked="checked" />
                                <label class="form-check-label mb-0" for="protection-option-1"> <strong>Full Refund </strong>If you don't <br class="d-none d-md-block d-lg-none" />receive your order</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" id="protection-option-2" type="checkbox" checked="checked" />
                                <label class="form-check-label mb-0" for="protection-option-2"> <strong>Full or Partial Refund, </strong>If the product is not as described in details</label>
                            </div><a class="fs-10 ms-3 ps-2" href="#!">Learn More<span class="fas fa-caret-right ms-1" data-fa-transform="down-2">    </span></a>
                        </div>
                    </div>
                    <div class="vertical-line d-none d-md-block d-xl-none d-xxl-block"> </div>
                </div>
                <div class="col-md-5 col-xl-12 col-xxl-5 ps-lg-4 ps-xl-2 ps-xxl-5 text-center text-md-start text-xl-center text-xxl-start">
                    <div class="border-bottom border-dashed d-block d-md-none d-xl-block d-xxl-none my-4"></div>
                    <div class="fs-7 fw-bold">All Total: <span class="text-primary">$3320</span></div>
                    <a href="#" class="btn btn-success mt-3 px-5" type="submit" data-spa="Invoice/PrintInvoice">Confirm &amp; Pay</a>
                    <p class="fs-10 mt-3 mb-0">By clicking <strong>Confirm & Pay </strong> button you agree to the <a href="#!">Terms &amp; Conditions</a></p>
                </div>
            </div>
         
    </div>
    
   
</div>

<div class="modal fade" id="staticBackdrop" data-bs-keyboard="false" data-bs-backdrop="static" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg mt-6" role="document">
        <div class="modal-content border-0 shadow-lg">
            <div class="position-absolute top-0 end-0 mt-3 me-3 z-1">
                <button class="btn-close btn btn-sm btn-circle d-flex flex-center transition-base" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0 fw-bold" id="staticBackdropLabel">Product Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-lg-4">
                                <h4 class="text-primary mb-3">Item Information</h4>
                                <p class="fs-7 text-muted">Vat Amount: <span class="fw-bold text-dark">10%</span></p>
                                <p class="fs-7 text-muted">Discount Amount: <span class="fw-bold text-dark">$5.00</span></p>
                                <p class="fs-7 text-muted">Date: <span class="fw-bold text-dark">24/10/2024</span></p>
                                <p class="fs-7 text-muted">Warranty: <span class="fw-bold text-dark">2 years</span></p>
                                <p class="fs-7 text-muted">Link to Supplier: <a href="#" class="fw-bold text-primary">View Supplier</a></p>
                                <p class="fs-7 text-muted">Remarks: <span class="fw-bold text-dark">Some remarks</span></p>
                                <p class="fs-7 text-muted">Descriptions: <span class="fw-bold text-dark">Product details here</span></p>
                                <p class="fs-7 text-muted">Imported From: <span class="fw-bold text-dark">Country</span></p>
                                <p class="fs-7 text-muted">Category: <span class="fw-bold text-dark">Electronics</span></p>

                            </div>
                            <div class="col-lg-4">
                                <h4 class="text-primary mb-3 mt-4">Pricing & Quantity</h4>
                                <p class="fs-7 text-muted">Sub Category: <span class="fw-bold text-dark">Smartphone</span></p>
                                <p class="fs-7 text-muted">Name/Model: <span class="fw-bold text-dark">Model X</span></p>
                                <p class="fs-7 text-muted">Buying Price: <span class="fw-bold text-dark">$500.00</span></p>
                                <p class="fs-7 text-muted">Selling Price: <span class="fw-bold text-dark">$700.00</span></p>
                                <p class="fs-7 text-muted">Unit Type: <span class="fw-bold text-dark">Piece</span></p>
                                <p class="fs-7 text-muted">Opening Quantity: <span class="fw-bold text-dark">50</span></p>
                                <p class="fs-7 text-muted">Alert Quantity: <span class="fw-bold text-dark">5</span></p>
                                <p class="fs-7 text-muted">Vat (in %): <span class="fw-bold text-dark">15%</span></p>
                                <p class="fs-7 text-muted">Discount (%): <span class="fw-bold text-dark">10%</span></p>
                            </div>
                            <!-- Right Column with Image and Additional Info -->
                            <div class="col-lg-4 d-flex flex-column align-items-center">
                                <div class="mb-3 text-center">
                                    <img class="rounded shadow mb-2" src="../../assets/img/gallery/2000.jpg" width="200" height="200" alt="Product Image" />
                                </div>
                                <div class="bg-light p-3 rounded w-100">
                                    <h5 class="fw-bold text-dark">Additional Information</h5>
                                    <p class="fs-7 text-muted">Stock Availability: <span class="fw-bold text-dark">In Stock</span></p>
                                    <p class="fs-7 text-muted">SKU: <span class="fw-bold text-dark">#12345</span></p>
                                    <p class="fs-7 text-muted">Supplier Rating: <span class="fw-bold text-dark">4.5/5</span></p>
                                    <p class="fs-7 text-muted">Shipping Time: <span class="fw-bold text-dark">3-5 Days</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        let allProducts = [];
        let isInitialized = false;
         let itemRowIndex = 0;
          const initialItems = @Html.Raw(Json.Serialize(Model.ItemsList)); // Or ViewBag.InitialItems
          console.log('int',initialItems);

         
          document.addEventListener("DOMContentLoaded", () => {
             const tableBody = document.querySelector('.table-view-tickets tbody');

             if (initialItems && Array.isArray(initialItems)) {
                 initialItems.forEach(item => {
                     console.log('item',item);
                    const rowHtml = generateItemRowHtml(item, itemRowIndex);
                    tableBody.insertAdjacentHTML('beforeend', rowHtml);
                    itemRowIndex++;
                 });
              }
          });
        // Fetch products
        async function fetchAllProducts() {
            try {
                const response = await fetch('/api/GetProducts');
                const data = await response.json();
                allProducts = data.isSuccess ? data.product_list : [];
                console.log('[DEBUG] All products fetched:', allProducts);
                isInitialized = true;
            } catch (error) {
                console.error('Error fetching products:', error);
                allProducts = [];
                isInitialized = true;
            }
        }

        // Get DOM elements dynamically
        function getElements() {
            return {
                searchInput: document.getElementById('chooseProduct'),
                searchDropdown: document.getElementById('searchDropdown'),
                dropdownList: document.querySelector('#searchDropdown .list'),
                noResultsMessage: document.querySelector('#searchDropdown .text-center p'),
                clearBtn : document.getElementById('clearBtn')
            };
        }

        // Filter products
        function filterProducts(query) {

            if (!query) return [];
            query = query.toLowerCase().trim();
            console.log('[DEBUG] Filtering with query:', query);
            return allProducts.filter(product =>
                product.prodName?.toLowerCase().includes(query) ||
                product.sku?.toLowerCase().includes(query) ||
                product.productCode?.toLowerCase().includes(query)
            );
        }

        // Populate dropdown
        function populateDropdown(products, elements) {

            elements.dropdownList.innerHTML = '';
            console.log('[DEBUG] Populating dropdown with:', products);
            if (products.length > 0) {
                elements.noResultsMessage.classList.add('d-none');
                products.forEach(product => {
                    const item = document.createElement('a');
                    item.className = 'dropdown-item px-x1 py-2';
                    //item.href = '#';
                    item.innerHTML = `
                        <div class="d-flex align-items-center ">
                            <div class="avatar avatar-l me-2">
                                <img class="rounded-circle" src="${product.imageUrl || '../../assets/img/default-product.jpg'}" alt="${product.prodName}" />
                            </div>
                            <div class="flex-1">
                                <h6 class="mb-0 title">${product.prodName}</h6>
                                <p class="fs-11 mb-0 d-flex">${product.sku || product.productCode || 'N/A'}</p>
                            </div>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                         elements.searchInput.value = product.prodName;
                         elements.clearBtn.classList.remove('d-none');
                         elements.searchDropdown.style.display = 'none';
                        // Call your function
                       AddItemToProductList(product);

                    });

                    elements.dropdownList.appendChild(item);
                });
            } else {
                elements.noResultsMessage.classList.remove('d-none');
            }
               const searchInput = document.getElementById('chooseProduct');
               const clearBtn = document.getElementById('clearBtn');
               //const dropdownList = document.getElementById('dropdownList');

                clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearBtn.classList.add('d-none'); // Hide the ❌ again
              //  dropdownList.style.display = 'block'; // Show dropdown list again

               // handleSearch(''); // Optional: re-trigger filtering if needed
               });
        }

        // Global handleSearch for oninput
        window.handleSearch = function (query) {
            console.log('[DEBUG] handleSearch called via oninput with query:', query);
            if (!isInitialized) {
                console.log('[DEBUG] Products not yet loaded, waiting...');
                return;
            }
            const elements = getElements();
            if (!elements.searchInput || !elements.searchDropdown || !elements.dropdownList || !elements.noResultsMessage) {
                console.error('[DEBUG] Elements not found in handleSearch:', elements);
                return;
            }
            console.log('[DEBUG] searchInput value from DOM:', elements.searchInput.value); // Cross-check
            if (query.length > 0) {
                elements.searchDropdown.style.display = 'block';
                const filteredProducts = filterProducts(query);
                populateDropdown(filteredProducts, elements);
            } else {
                elements.searchDropdown.style.display = 'none';
                elements.dropdownList.innerHTML = '';
                elements.noResultsMessage.classList.add('d-none');
            }
        };

        // Initialize search functionality
        window.initializeInvoiceSearch = async function () {
            console.log('[DEBUG] Initializing Invoice search');
            const elements = getElements();
            if (!elements.searchInput || !elements.searchDropdown) {
                console.error('[DEBUG] Required elements not found after render:', elements);
                return;
            }
            await fetchAllProducts(); // Fetch products and set isInitialized

            // Attach click-outside listener (no input listener needed due to oninput)
            document.addEventListener('click', (e) => {
                if (!elements.searchInput.contains(e.target) && !elements.searchDropdown.contains(e.target)) {
                    elements.searchDropdown.style.display = 'none';
                }
            });
        };

        // Expose fetchAllProducts for debugging (optional)
        //window.fetchAllProducts = fetchAllProducts;

       
             function AddItemToProductList(item) {
            console.log('product', item);
          const tableBody = document.querySelector('.table-view-tickets tbody');
          const rowHtml = generateItemRowHtml(item, itemRowIndex);
          tableBody.insertAdjacentHTML('beforeend', rowHtml);
          itemRowIndex++;
        }

            function generateItemRowHtml(item, index) {
        return `
            <tr>
                <td>
                    <div class="col-auto">
                        <div class="avatar avatar-2xl">
                            <img class="rounded-circle" src="${item.imageUrl}" alt="${item.prodName}" />
                        </div>
                    </div>
                    <input type="hidden" name="ItemsList[${index}].ProductId" value="${item.productId}" />
                </td>
                <td><input type="text" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" readonly value="${item.prodCtgName}" /></td>
                <td><input type="text" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" readonly value="${item.prodSubCtgName}" /></td>
                <td><input type="text" class="form-control form-control-sm form-rounded bold-input fw-semi-bold" readonly value="${item.prodName}" /></td>
                <td>
                    <input type="number" class="form-control form-control-sm form-rounded bold-input fw-semi-bold"
                           placeholder="Quantity" name="ItemsList[${index}].Quantity" value="1" />
                    <span class="text-danger validation-error" data-field="Quantity" style="display:none;">Quantity is required</span>
                </td>
                <td><input type="text" class="form-control form-control-sm form-rounded fw-semi-bold" readonly value="${item.unitName}" /></td>
                <td>
                    <input type="number" class="form-control form-control-sm form-rounded fw-semi-bold"
                           name="ItemsList[${index}].SellingPrice" value="${item.sellingPrice}" />
                    <span class="text-danger validation-error" data-field="SellingPrice" style="display:none;">Selling Price is required</span>
                </td>
                <td><input type="number" class="form-control form-control-sm form-rounded fw-semi-bold" readonly value="${item.vatPercent}" /></td>
                <td>
                    <input type="number" class="form-control form-control-sm form-rounded fw-semi-bold"
                           name="ItemsList[${index}].DiscountPercentg" value="${item.discountPercentg}" />
                    <span class="text-danger validation-error" data-field="DiscountPercentg" style="display:none;">Discount is required</span>
                </td>
                <td><input type="number" class="form-control form-control-sm form-rounded fw-semi-bold" readonly value="${item.totalPrice}" /></td>

                <!-- Serial Toggle Column -->
                <td class="treeview">
                    <div class="treeview-list-item">
                        <a data-bs-toggle="collapse" href="#treeviewExample-1_${index}" role="button" aria-expanded="false">
                            <p class="treeview-text">Serial</p>
                        </a>
                    </div>
                </td>
                 <td>
                    <button type="button" title="Info" class="btn btn-sm a-light" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                      <i class="fa fa-info-circle" style="font-size:18px"></i>
                    </button>
                  </td>

                <!-- Delete Button -->
                <td>
                    <button type="button" title="Delete" class="btn btn-sm btn-light" onclick="deleteDynamicRow(this)">
                        <i class="far fa-trash-alt fa-lg text-danger"></i>
                    </button>
                </td>
            </tr>

            <!-- Collapsible Row -->
            <tr>
                <td colspan="12">
                    <div class="collapse treeview-list" id="treeviewExample-1_${index}">
                        <div class="table-responsive scrollbar row">
                            <div class="col-sm-8 col-md-8 col-lg-8 col-xl-8">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="fw-semi-bold" scope="col">Product Name</th>
                                            <th scope="col">Serial No</th>
                                            <th scope="col">Supplier Org</th>
                                            <th scope="col">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serial-body-${index}">
                                        <!-- Serial rows will be appended dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-4 col-md-4 col-lg-4 col-xl-4">
                                <label class="form-label fw-semi-bold">Add Serial Number</label>
                                <div class="position-relative">
                                    <button class="btn btn-sm btn-light position-absolute end-0 h-100" type="button"
                                            data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight-2" aria-controls="offcanvasRight-2">
                                        +
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }


     window.deleteDynamicRow = function (btn) {
        // Find and remove the main item row (this is the row where the delete button was clicked)
        const row = btn.closest('tr');
        row.remove();

        // Find and remove the corresponding collapsible serial row
        const index = row.querySelector('input[name^="ItemsList"]').name.match(/\[(\d+)\]/)[1];
        const serialRow = document.querySelector(`#treeviewExample-1_${index}`).closest('tr');
        if (serialRow) {
            serialRow.remove();  // Remove the collapsible row
        }

        // Optionally, collapse the corresponding serial view if needed
        const collapseElement = document.querySelector(`#treeviewExample-1_${index}`);
        if (collapseElement) {
            collapseElement.classList.remove('show');  // Hide the collapse if it's still shown
        }

        // Optional: Clean up any CSS if borders or extra space is still showing
        const tableBody = document.querySelector('.table-view-tickets tbody');
        if (tableBody) {
            tableBody.style.borderCollapse = 'collapse'; // Ensure no leftover spacing
        }
    }


      window.postItemsToApi = function () {
              const rows = document.querySelectorAll('.table-view-tickets tbody tr');
            const items = [];
            let rowIndex = 0;
            let isValid = true;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];

                const quantityInput = row.querySelector('[name^="ItemsList["][name$="].Quantity"]');
                if (!quantityInput) continue; // Skip non-data rows

                const productIdInput = row.querySelector('[name^="ItemsList["][name$="].ProductId"]');
                const sellingPriceInput = row.querySelector('[name^="ItemsList["][name$="].SellingPrice"]');
                const discountPercentInput = row.querySelector('[name^="ItemsList["][name$="].DiscountPercentg"]');

                // Hide all error spans first
                row.querySelectorAll('.validation-error').forEach(e => e.style.display = 'none');

                // Manual validation
                if (!quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                    const errSpan = row.querySelector('[data-field="Quantity"]');
                    if (errSpan) errSpan.style.display = 'block';
                    isValid = false;
                }

                if (!sellingPriceInput.value || parseFloat(sellingPriceInput.value) <= 0) {
                    const errSpan = row.querySelector('[data-field="SellingPrice"]');
                    if (errSpan) errSpan.style.display = 'block';
                    isValid = false;
                }

                // Optional: validate discountPercentInput if needed

                items.push({
                    rowIndex: rowIndex,
                    productId: parseInt(productIdInput?.value || 0),
                    quantity: parseFloat(quantityInput?.value || 0),
                    sellingPrice: parseFloat(sellingPriceInput?.value || 0),
                    discountPercentg: parseFloat(discountPercentInput?.value || 0),
                });

                rowIndex++;
            }

            if (!isValid) {
                console.warn("Validation failed!");
                return;
            }

            console.log("Items to send:", items);

            fetch('/api/Invoice/save-items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(items)
            })
            .then(res => res.json())
            .then(data => {
                console.log("Saved!", data);
            })
            .catch(err => {
                console.error("Save failed", err);
            });
        }
            

    })();


</script>


  